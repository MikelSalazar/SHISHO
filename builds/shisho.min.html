<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>SHISHO SHISHO Template</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style> html, body { width:100%; height:100%; margin:0; } </style>
		<script>
// SHISHO

class SHISHO{constructor(e={}){this._viewports=[];let t=this._instanceNumber=SHISHO.instances.length;let i=this._instanceString="ShishoApp"+(t>0?t:"");SHISHO.instances.push(this);this._data=new Root({name:"unnamed_ontology"});this.viewports.push(new Viewport(this,e));if(e.data){if(typeof e.dataElement==="string"){this._dataElement=document.getElementById(e.dataElement);if(!this._dataElement)throw new Error("Invalid data element")}else this._dataElement=e.dataElement}else this._dataElement=document.getElementById(i+"Data");this.deserialize(e.data);console.log(SHISHO.AppName+" "+SHISHO.AppVersion+" Initialized")}static get AppName(){return"SHISHO"}static get AppVersion(){return"0.4.1"}static get instances(){return this._instances}get viewports(){return this._viewports}get data(){return this._data}static init(e){return new SHISHO(e)}deserialize(e){if(!e){if(this._dataElement)e=this._dataElement.textContent}try{if(typeof e=="string"){let t=e.indexOf("{"),i=e.lastIndexOf("}");if(t<0||i<0)throw new Error("Invalid JSON data");let s=e.slice(t,i+1);e=JSON.parse(s)}this._data.deserialize(e)}catch(e){Dialog.create("Error",this._viewports[0].layers.dialog,"Error","Unable to load data.<br>"+e.message);return false}}serialize(){let e="";if(this._saveToElement){if(!this._dataElement){this._dataElement=document.createElement("script");this._dataElement.id=this._instanceString+"Data";document.body.append(this._dataElement)}this._dataElement.textContent="\nlet "+this._instanceString+"Data = "+e+";\n"}return e}}SHISHO._instances=[];class JsonSchemaExporter{static export(e){let t={$id:"https://example.com/example.schema.json",$schema:"http://json-schema.org/draft-07/schema#",properties:{}};for(let i in e.classes){let s=e.classes[i];let n=t.properties[s.name]={};n.type="object";n.description=s.description}let i=JSON.stringify(t,null,"  ");let s=new Blob([i],{type:"text/plain;charset=utf-8"});let n=window.URL.createObjectURL(s);let r=document.createElement("a");document.body.appendChild(r);r.style.display="none";r.href=n;r.download="schema.json";r.click();setTimeout((function(){document.body.removeChild(r);window.URL.revokeObjectURL(n)}),0);return i}}class OwlExporter{static export(e){let t="";for(let t in e.classes){let i=e.classes[t]}return t}}class SqlExporter{static export(e){let t="";for(let t in e.classes){let i=e.classes[t]}return t}}class OwlImporter{constructor(e,t,i=true){let s=new DOMParser;let n=s.parseFromString(t,"text/xml");let r=null;for(let e of n.getRootNode().children)if(e.nodeName=="rdf:RDF")r=e;if(!r)throw new Error("Invalid OWL File. ");if(i)e.deserialize();for(let t of r.children){switch(t.nodeName){case"owl:Ontology":let i,s=this.getName(t);break;case"owl:Class":let n,r=this.getName(t);if(r)n=new Class({name:r});else throw Error("Class name not defined");let l=this.findElement("entityPositionX",t);let a=this.findElement("entityPositionY",t);n.positions=[new Vector({x:l?parseFloat(l.textContent):0,y:a?parseFloat(a.textContent):0})];console.log("Created Class: "+n.name+": "+JSON.stringify(n.positions));e.classes[r]=n;break;case"owl:ObjectProperty":let o,h=null;for(let e of t.attributes){if(e.name.toLowerCase()=="rdf:id")h=e.textContent;if(e.name.toLowerCase()=="rdf:about")h=e.textContent.split("#")[1]}let d=this.findElement("domain",t);let c=this.findElement("range",t);let u=this.extractName(d.attributes[0]);let p=this.extractName(c.attributes[0]);o=new Relation({name:h,origin:u,target:p});e.relations[h]=o;console.log("Relation:"+h);break}}Object.keys(e.relations).forEach((t=>{let i=e.relations[t];if(!e.classes[i.origin])throw Error("Class not defined: '"+i.origin+"' in relation '"+t+"'");if(!e.classes[i.target])throw Error("Class not defined: '"+i.target+"' in relation '"+t+"'")}))}getName(e){let t,i=null;for(let i of e.attributes){switch(i.name.toLowerCase()){case"rdf:id":return i.textContent;case"rdf:about":t=this.extractName(i);break}}return t}extractName(e){return e.textContent.split("#")[1]}findElement(e,t){let i=[t];while(i.length>0){let t=i.pop();if(t.nodeName.includes(e))return t;i.push(...t.children)}return null}}class Node{constructor(e={}){this.deserialize(e)}serialize(){return null}deserialize(e){}}class Class extends Node{constructor(e={}){super(e);this.properties={};this.positions=[]}deserialize(e){if(!e.name)throw Error("Class without name");this.name=e.name;this.description=e.description||"";this.properties={};if(e.properties)e.properties.forEach((e=>{if(!e.name)throw Error("Property without name");this.properties[e.name]=new Property(e)}));this.positions=[];if(e.positions)e.positions.forEach((e=>{this.positions.push(new Vector(e))}))}}class Color extends Node{constructor(e={}){super(e)}deserialize(e){this.set(e.r,e.g,e.b)}set(e=0,t=0,i=0){this.r=e;this.g=t;this.b=i}}class Ontology extends Node{constructor(e={}){super(e);this.classes={};this.relations={}}deserialize(e={}){this.name=e.name;this.description=e.description||"";this.classes={};if(e.classes)e.classes.forEach((e=>{if(!e.name)throw Error("Class without name");this.classes[e.name]=new Class(e)}));this.relations={};if(e.relations)e.relations.forEach((e=>{if(!e.name)throw Error("Relation without name");this.relations[e.name]=new Relation(e)}))}}class Property extends Node{constructor(e={}){super(e)}deserialize(e){if(!e.name)throw Error("Property without name");this.name=e.name;this.description=e.description}}class Relation extends Node{constructor(e={}){super(e)}deserialize(e){if(!e.name)throw Error("Relation without name");this.name=e.name;this.description=e.description;this.origin=e.origin;this.target=e.target}}class Root extends Node{constructor(e={}){super(e);this.styles={}}deserialize(e={}){this.name=e.name;this.description=e.description;this.author=e.author;this.ontology=new Ontology(e.ontology)}}class Style extends Node{constructor(e={}){super(e)}get name(){return this._name}get parent(){return this._parent}get shape(){return this.parsePropertyValue("_shape")}set shape(e){this._shape=e}get width(){return this.parsePropertyValue("_width")}set width(e){this._width=e}get height(){return this.parsePropertyValue("_height")}set height(e){this._height=e}get radius(){return this.parsePropertyValue("_radius")}set radius(e){this._radius=e}get radius2(){return this.parsePropertyValue("_radius2")}set radius2(e){this._radius2=e}get color(){return this.parsePropertyValue("_color")}set color(e){this._color=e}get borderColor(){return this.parsePropertyValue("_borderColor")}set borderColor(e){this._borderColor=e}get borderWidth(){return this.parsePropertyValue("_borderWidth")}set borderWidth(e){this._borderWidth=e}get textFont(){return this.parsePropertyValue("_textFont")}set textFont(e){this._textFont=e}get textSize(){return this.parsePropertyValue("_textSize")}set textSize(e){this._textSize=e}get textAlign(){return this.parsePropertyValue("_textAlign")}set textAlign(e){this._textAlign=e}get textColor(){return this.parsePropertyValue("_textColor")}set textColor(e){this._textColor=e}deserialize(e){this._name=e.name;this._parent=e.parent;this._children=[];if(this._parent)this._children.push(this.name);this.shape=e.shape;this.width=e.width;this.height=e.height;this.radius=e.radius;this.radius2=e.radius2;this.color=e.color;this.borderColor=e.borderColor;this.borderWidth=e.borderWidth;this.textFont=e.textFont;this.textSize=e.textSize;this.textAlign=e.textAlign;this.textFont=e.textFont;this.textColor=e.textColor}parsePropertyValue(e){let t=this[e],i=this._parent;return t}}class Vector extends Node{constructor(e={}){super(e)}deserialize(e){this.set(e.x,e.y)}set(e=0,t=0){this.x=e;this.y=t}}class Widget{constructor(e,t,i){this._children=[];this._visibility=1;this._removeIfHidden=false;this._name=e;this._parent=t;this._element=i;if(t){this.parent.children.push(this);if(i&&t.element&&i.parentElement!=t.element){t.element.appendChild(i)}}}get name(){return this._name}get element(){return this._element}get parent(){return this._parent}set parent(e){this._parent=e;let t=this.element;if(t&&t.parentElement)t.parentElement.removeChild(t);if(t&&this._parent.element)this._parent.element.appendChild(t)}get children(){return this._children}get visibility(){return this._visibility}update(e){let t=this._element,i=this._parent;if(this._removeIfHidden&&this._visibility<=0){if(t&&this._element.parentElement)t.parentElement.removeChild(t);if(this._parent){const e=i.children.indexOf(this);if(e>=0)i._children.splice(e,1)}return}if(t&&this._visibility!=1){t.style.opacity=""+this._visibility}if(this._visibility<=0)return;for(const t of this._children)t.update(e)}show(){this._visibility=1}hide(){this._visibility=0;console.log("Hiding "+this.name)}handleEvent(e){let t=0,i=this._children.length;for(t=i-1;t>=0;t--)if(this._children[t].handleEvent(e))return true;return false}}class Layer extends Widget{constructor(e,t,i){super(e,null,createElement(i,t.element,t.element.id+e,null,"ShishoLayer"));this._name=e;this._viewport=t}get viewport(){return this._viewport}}class DialogLayer extends Layer{constructor(e){super("Dialog",e,"div")}}class MainLayer extends Layer{constructor(e){super("Main",e,"div");this._graph=new Graph("Graph",this)}get name(){return this._name}}class MenuLayer extends Layer{constructor(e){super("Menu",e,"canvas");this._shapes=[];this._canvas=this._element;this._context=this._canvas.getContext("2d");let t=new Style({name:"test",shape:"circle",color:"blue",radius:"128"});this._shapes.push(new Shape("a",new Vector({x:0,y:0}),[t]));this._shapes.push(new Shape("b",new Vector({x:0,y:0}),[t]));this._shapes.push(new Shape("c",new Vector({x:0,y:0}),[t]));this._shapes.push(new Shape("d",new Vector({x:0,y:0}),[t]))}get canvas(){return this._canvas}get shapes(){return this._shapes}update(e){super.update(e);let t=this._canvas,i=this._context;let s=t.width=this._viewport.width,n=t.height=this._viewport.height;i.clearRect(0,0,s,n);this._shapes[0].position.set(64,64);this._shapes[1].position.set(s-64,64);this._shapes[2].position.set(64,n-64);this._shapes[3].position.set(s-64,n-64);let r,l=this._shapes.length;for(r=0;r<l;r++){this._shapes[r].draw(i)}}}class Shape{constructor(e,t,i=null,s=null,n=null){this._visibility=1;this._name=e;this._position=t||new Vector;this._styles=i||[];this._text=s}get name(){return this._name}get position(){return this._position}get styles(){return this._styles}get text(){return this._text}get visibility(){return this._visibility}draw(e){let t=this._styles[0];let i=this._position;e.beginPath();switch(t.shape){case"circle":if(t.radius==undefined)throw Error("No radius defined");let s=parseFloat(t.radius);e.arc(i.x,i.y,s,0,2*Math.PI);break;case"rectangle":break;default:throw Error("Invalid Shape Type");break}if(t.color){e.fillStyle=t.color;e.fill()}if(t.borderColor&&t.borderWidth){e.lineWidth=parseFloat(t.borderWidth);e.strokeStyle=t.borderColor;e.stroke()}if(t.textColor&&t.textFont){e.textAlign="center";e.textBaseline="middle";e.fillStyle=t.textColor;e.font=t.textSize+" "+t.textFont;e.fillText(this._text,i.x,i.y)}}isInside(e){return false}}class Viewport{constructor(e,t={}){this._layers={};this._app=e;this._parentElement=t.parentElement||document.body;let i=SHISHO.instances.length;if(i==1){createCssRule(".ShishoViewport","position: relative;"+"width: 100%; height: 100%; margin:0; overflow: hidden;");createCssRule(".ShishoLayer","position: absolute;"+"width: 100%; height: 100%; margin:0; overflow: hidden;");createCssRule(".ShishoBackground","position: absolute;"+"width: 100%; height: 100%; margin:0; overflow: hidden;"+"background: #00000080; ");createCssRule(".ShishoWindow","position: relative;"+"top: 50%; left: 50%; transform: translate(-50%,-50%); "+"box-sizing: border-box; background: white; color: black;"+"border: 2px solid blue; border-radius: 2vmin;"+"font-family: Arial, Helvetica, sans-serif; font-size: 2vmin;"+"width: max-content; height:max-content; box-sizing: border-box;");createCssRule(".ShishoWindowTitle","width:100%; box-sizing: border-box;"+"background: blue; color: white; border-radius: 2vmin;"+"font-size: 3vmin; text-align: center; padding: 1vmin;");createCssRule(".ShishoWindowContents","min-width:10vmin; min-height:10vmin; padding: 1vmin;"+"text-align: center;");createCssRule(".ShishoWindowContents label ","font-weight:bold");createCssRule(".ShishoWindowContents input, .ShishoWindowContents select","font-family: Arial, Helvetica, sans-serif; font-size: 2vmin;");createCssRule(".ShishoWindowButtonGroup","display:flex; justify-content: space-evenly;");createCssRule(".ShishoWindowButton","width:max-content; height:max-content; margin: 1vmin;"+"background: blue; color: white; border-radius: 2vmin;"+"font-size: 3vmin; text-align: center; padding: 1vmin;")}this._element=createElement("div",this._parentElement,"ShishoViewport"+i,null,"ShishoViewport");let s=this._layers.main=new MainLayer(this);let n=this._layers.menu=new MenuLayer(this);let r=this.layers.dialog=new DialogLayer(this);document.addEventListener("keyup",(e=>{if(e.ctrlKey&&e.code=="KeyI"){if(this.layers.dialog.children.length==0)Dialog.create("Import",this.layers.dialog)}if(e.ctrlKey&&e.code=="KeyE"){if(this.layers.dialog.children.length==0)Dialog.create("Export",this.layers.dialog)}e.preventDefault()}));function l(e){if(this._layers.dialog.handleEvent(e))return;if(this._layers.menu.handleEvent(e))return;if(this._layers.main.handleEvent(e))return}document.addEventListener("pointerdown",l.bind(this));document.addEventListener("pointermove",l.bind(this));document.addEventListener("pointerup",l.bind(this));document.addEventListener("touchdown",l.bind(this));document.addEventListener("touchmove",l.bind(this));document.addEventListener("touchup",l.bind(this));this.update(0)}get app(){return this._app}get layers(){return this._layers}get parentElement(){return this._parentElement}get element(){return this._element}get deltaTime(){return this._deltaTime}get width(){return this._element.clientWidth}get height(){return this._element.clientHeight}update(e=0){let t=e>0?e/1e3:.001;this._deltaTime=t-this._lastTime;this._lastTime=t;if(this._deltaTime>.1)this._deltaTime=.1;for(const e in this._layers){this._layers[e].update(this._deltaTime)}requestAnimationFrame(this.update.bind(this))}}function createElement(e,t,i=null,s=null,n=null,r=null,l=null){if(!e)throw Error("Tag required");let a=document.createElement(e);if(t)t.appendChild(a);if(i)a.id=i;if(s)a.id=s;if(n)a.className=n;if(r)a.style.cssText=r;if(l)a.innerText=l;return a}function createCssRule(e,t,i=false){if(document.styleSheets.length==0)document.head.append(document.createElement("style"));let s=document.styleSheets[0];let n=e+" {"+t+"}";let r=s.cssRules,l,a=r.length;for(l=0;l<a;l++){if(r[l].cssText.indexOf(e)==0&&r[l].cssText[e.length]==" "){if(i)r[l].cssText=n;return}}s.insertRule(e+" {"+t+"}",a)}class Background extends Widget{constructor(e,t){super(e,t,createElement("div",t.element,t.element+"Background",null,"ShishoBackground"));this._removeIfHidden=true}}class Button extends Widget{constructor(e,t,i,s=[]){super(e,t);this._text=i;this._callbacks=s;let n=t&&t.element?t.element:null;this._element=createElement("div",n,e,null,"ShishoWindowButton",null,this._text);this._element.addEventListener("click",(e=>{for(let e of this._callbacks)if(e(this)==false)return}))}get text(){return this._text}get callbacks(){return this._callbacks}}class Dialog extends Widget{constructor(e,t,i,s,n,r){super(e,t);this._removeIfHidden=true;this._title=i;this._contents=s;this._buttons=n;this._background=r;let l=t&&t.element?t.element:null;if(this.background)l=r.element;this._element=createElement("div",l,e,null,"ShishoWindow");this._titleGroup=new Widget("TitleGroup",this,createElement("div",this._element,e+i,null,"ShishoWindowTitle",null,this._title));this._contentsGroup=new Widget("ContentsGroup",this,createElement("div",this._element,e+i,null,"ShishoWindowContents"));for(let e of this._contents)e.parent=this._contentsGroup;this._buttonGroup=new Widget("ButtonGroup",this,createElement("div",this._element,e+"Buttons",null,"ShishoWindowButtonGroup"));for(let e of this._buttons){e.parent=this._buttonGroup;e.callbacks.push((()=>{this.hide();if(this._background)this._background.hide()}))}}get background(){return this._background}get title(){return this._title}get contents(){return this._contents}get buttons(){return this._buttons}update(e){super.update(e)}static create(e,t,i=null,s=null){switch(e){case"Import":return new Dialog("Import",t,"Import File...",[new FileInput("FileInput",null,"File: "),new Selector("FileType",null,"File Type: ",["OWL","JSON"])],[new Button("Cancel",null,"Cancel"),new Button("Import",null,"Import",[e=>{let i=e.parent.parent;let s=i.contents[0];let n=i.contents[1];console.log(s.filePath);try{if(s.filePath==null)throw Error("No file provided.");new OwlImporter(t.viewport.app.data.ontology,s.fileData)}catch(e){console.error(e);Dialog.create("Error",t,"Error","Unable to import File.<br>"+e.message);return false}}])],new Background("ImportBackground",t));case"Export":return new Dialog("Export",t,"Export File...",[new Selector("FileType",null,"File Type: ",["OWL","SCHEMA.JSON","SQL"])],[new Button("Cancel",null,"Cancel"),new Button("Export",null,"Export",[e=>{let i=e.parent.parent;let s=i.contents[0];let n=t.viewport.app.data.ontology;let r="";switch(s.selectedOption){case"OWL":r=OwlExporter.export(n);break;case"SCHEMA.JSON":r=JsonSchemaExporter.export(n);break;case"SQL":r=SqlExporter.export(n);break}console.log(r)}])],new Background("ImportBackground",t));case"Error":return new Dialog("Error",t,i,[new Text("ErrorMessage",null,s)],[new Button("OK",null,"OK")],new Background("ErrorBackground",t))}}}class FileInput extends Widget{constructor(e,t,i){super(e,t);this._label=i;let s=t&&t.element?t.element:null;this._element=createElement("p",s,e);this._labelElement=createElement("label",this._element,e+"Label",null,null,null,i);this._inputElement=createElement("input",this._element,e+"Input");this._inputElement.type="file";this._inputElement.onchange=e=>{let t=e.target.files[0];this._fileName=t.name;this._filePath=t.path;let i=new FileReader;i.readAsText(t,"UTF-8");i.onload=e=>{this._fileData=e.target.result.toString()}}}get fileName(){return this._fileName}get filePath(){return this._filePath}get fileData(){return this._fileData}}class Graph extends Widget{constructor(e,t){super(e,t,createElement("canvas",t.element,t.name+"Canvas"));this._shapes=[];this._canvas=this._element;this._context=this._canvas.getContext("2d");this._translate=new Vector}update(e){super.update(e);let t=this._canvas,i=this._context;let s=t.width=this.parent.element.clientWidth,n=t.height=this.parent.element.clientHeight;i.clearRect(0,0,s,n);i.fillStyle="white";i.fillRect(0,0,s,n);i.translate(this._translate.x,this._translate.y);let r=this.parent.viewport.app.data.ontology;i.fillStyle="black";i.font="16px Arial";i.textAlign="center";i.textBaseline="middle";this._shapes=[];for(let e in r.relations){let t=r.relations[e];let s=r.classes[t.origin].positions[0];let n=r.classes[t.target].positions[0];i.beginPath();i.moveTo(s.x,s.y);i.lineTo(n.x,n.y);i.stroke();i.textAlign="center";i.textBaseline="middle";i.fillStyle="black";i.font="Arial 12px";i.fillText(t.name,(s.x+n.x)/2,(s.y+n.y)/2)}let l=new Style({name:"simple",shape:"circle",radius:"50",color:"white",borderWidth:"2",borderColor:"black",textColor:"black",textFont:"Arial",textSize:"16px"});for(let e in r.classes){let t=r.classes[e];let s=new Shape(t.name,t.positions[0],[l],t.name);this._shapes.push(s);s.draw(i)}}handleEvent(e){switch(e.type){case"pointermove":let t=e;if(t.buttons==1){this._translate.x+=t.movementX;this._translate.y+=t.movementY}break;case"touchmove":let i=e;console.log("touchmove");break}return true}}class Label extends Widget{constructor(e,t,i){super(e,t,createElement("label",null));this.text=i}get text(){return this._text}set text(e){this._element.innerHTML=this._text=e}}class Selector extends Widget{constructor(e,t,i,s){super(e,t);this._label=i||"";this._options=s||[];let n=t&&t.element?t.element:null;this._element=createElement("p",n,e);this._labelElement=createElement("label",this._element,e+"Label",null,null,null,i);this._selectElement=createElement("select",this._element,e+"Label",null,null,null,i);let r=0,l=this._options.length;for(r=0;r<l;r++){let e=createElement("option",this._selectElement,null,null,null,null,this._options[r]);e.value=""+r}}get selectedOption(){return this._options[this.selectedIndex]}get selectedIndex(){return parseInt(this._selectElement.value)}}class Text extends Widget{constructor(e,t,i){super(e,t,createElement("p",null));this.text=i}get text(){return this._text}set text(e){this._element.innerHTML=this._text=e}}
		</script>
	</head>
	<body>
		<script>SHISHO.init();</script>
	</body>
</html>
